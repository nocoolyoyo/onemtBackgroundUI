<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.wkt.dao.topic.ITopicDao">
	<!-- 查询话题列表总条数 -->
	<select id="findTopicCount" parameterType="java.util.HashMap" resultType="Integer">
		SELECT
			COUNT(*) count
		FROM
			(
				SELECT
					a.id,
					a.title,
					a.author_id,
					a.author_name,
					a.create_time,
					a.update_time,
					a.audit_time,
					(
						select yjp.circle_nr_names from yj_feed_push_tmp yjp
						 where yjp.is_push_again=1
						   and yjp.is_push_type=1
						   and yjp.obj_id=a.id
						   and yjp.obj_type=5
					) circle_title,
					a.`status`,
					a.state
				FROM
					yj_topic a
			) t
		WHERE
			t.`status` = #{status}
		<if test="state != null and state != ''">
			AND t.state IN (${state})
		</if>
		<if test="create_start_time != null and create_start_time != ''">
			AND t.create_time >= #{create_start_time}
		</if>
		<if test="create_end_time != null and create_end_time != ''">
			<![CDATA[AND t.create_time <= #{create_end_time}]]>
		</if>
		<if test="audit_start_time != null and audit_start_time != ''">
			AND t.audit_time >= #{audit_start_time}
		</if>
		<if test="audit_end_time != null and audit_end_time != ''">
			<![CDATA[AND t.audit_time <= #{audit_end_time}]]>
		</if>
		<if test="startupdatetime != null and startupdatetime != ''">
			AND t.update_time >= #{startupdatetime}
		</if>
		<if test="endupdatetime != null and endupdatetime != ''">
			<![CDATA[AND t.update_time <= #{endupdatetime}]]>
		</if>
		<if test="title != null and title != ''">
			AND t.title LIKE '%${title}%'
		</if>
		<if test="circle_title != null and circle_title != ''">
			AND t.circle_title LIKE '%${circle_title}%'
		</if>
	</select>
	<!-- 获取话题列表 -->
	<select id="findTopicList" parameterType="java.util.HashMap" resultType="java.util.HashMap">
		SELECT
			*
		FROM
			(
				SELECT
					a.*,
					5 as obj_type,
					(
						select yjp.circle_nr_names from yj_feed_push_tmp yjp
						 where yjp.is_push_again=1
						   and yjp.is_push_type=1
						   and yjp.obj_id=a.id
						   and yjp.obj_type=5
					) circle_title
				FROM
					yj_topic a
			) t
		WHERE
			t.`status` = #{status}
		<if test="state != null and state != ''">
			AND t.state IN (${state})
		</if>
		<if test="create_start_time != null and create_start_time != ''">
			AND t.create_time >= #{create_start_time}
		</if>
		<if test="create_end_time != null and create_end_time != ''">
			<![CDATA[AND t.create_time <= #{create_end_time}]]>
		</if>
		<if test="audit_start_time != null and audit_start_time != ''">
			AND t.audit_time >= #{audit_start_time}
		</if>
		<if test="audit_end_time != null and audit_end_time != ''">
			<![CDATA[AND t.audit_time <= #{audit_end_time}]]>
		</if>
		<if test="startupdatetime != null and startupdatetime != ''">
			AND t.update_time >= #{startupdatetime}
		</if>
		<if test="endupdatetime != null and endupdatetime != ''">
			<![CDATA[AND t.update_time <= #{endupdatetime}]]>
		</if>
		<if test="title != null and title != ''">
			AND t.title LIKE '%${title}%'
		</if>
		<if test="circle_title != null and circle_title != ''">
			AND t.circle_title LIKE '%${circle_title}%'
		</if>
		ORDER BY
			t.update_time desc,
			t.create_time desc
		<if test="y != null and y != ''">
			LIMIT ${x},${y}
		</if>
	</select>
	<!-- 查询话题详情 -->
	<select id="findTopicDetail" parameterType="java.util.HashMap" resultType="java.util.HashMap">
		SELECT
			t.id,
			t.title,
			t.create_time,
			t.content,
			t.create_time,
			t.content,
			t.state,
			t.summary
		FROM
			yj_topic t
		WHERE
			t.id = #{id}
	</select>
	<!-- 查询话题受邀人 -->
	<select id="findTopicGuest" parameterType="java.util.HashMap" resultType="java.util.HashMap">
		SELECT
			g.id,
			g.topic_id,
			g.user_id,
			g.user_avatar,
			g.user_type,
			g.user_name,
			g.user_identity,
			g.user_v,
			g.display_order,
			g.is_send
		FROM
			yj_topic_guest g
		WHERE
			g.`status` = 1
		AND topic_id = #{topic_id}
		ORDER BY
			display_order
	</select>
	
	<!-- 查询未推送过得话题受邀人 -->
	<select id="findTopicGuestNotSend" parameterType="java.util.HashMap" resultType="java.util.HashMap">
		SELECT
			g.id,
			g.topic_id,
			g.user_id,
			g.user_avatar,
			g.user_type,
			g.user_name,
			g.user_identity,
			g.user_v,
			g.display_order
		FROM
			yj_topic_guest g
		WHERE
			g.`status` = 1
			and g.is_send = 2
			and g.user_type = 0
		AND topic_id = #{topic_id}
		ORDER BY
			display_order
	</select>
	
	<!-- 查询话题相关新闻 -->
	<select id="findTopicRelated" parameterType="java.util.HashMap" resultType="java.util.HashMap">
		SELECT
			*
		FROM
			yj_topic_related t
		WHERE 1=1
		AND t.topic_id = #{topic_id}
		<if test="type != null and type != ''">
			AND t.type = #{type}
		</if>
		ORDER BY
			display_order
	</select>
	<!-- 审核、删除话题 -->
	<update id="auditTopic" parameterType="java.util.HashMap">
		UPDATE yj_topic
		SET audit_type = 2
		 ,audit_user_id = #{audit_user_id}
		 <if test="audit_user_name != null and audit_user_name != ''">
		 	,audit_user_name = #{audit_user_name}
		 </if>
		 <if test="audit_time != null and audit_time != ''">
		 	,audit_time = #{audit_time}
		 </if>
		 <if test="update_time != null and update_time != ''">
		 	,update_time = #{update_time}
		 	,update_type = 2
		 </if>
		  <if test="update_name != null and update_name != ''">
		 	,update_name = #{update_name}
		 </if>
		 <if test="update_id != null and update_id != ''">
		 	,update_id = #{update_id}
		 </if>
		 <if test="audit_opinion != null and audit_opinion != ''">
		 	,audit_opinion = #{audit_opinion}
		 </if>
		 <if test="state != null and state != ''">
		 	,state = #{state}
		 </if>
		 <if test="status != null and status != ''">
		 	,status = #{status}
		 </if>
		 <if test="title != null and title != ''">
		 	,title = #{title}
		 </if>
		 <if test="content != null and content != ''">
		 	,content = #{content}
		 </if>
		 <if test="summary != null and summary != ''">
			,summary = #{summary}
		 </if>
		WHERE
			id IN (${id})
	</update>
	<!-- 新增话题 -->
	<insert id="insertTopic" parameterType="java.util.HashMap" useGeneratedKeys="true" keyProperty="id">
		INSERT INTO yj_topic (
			title
			,author_id
			<if test="author_name != null and author_name != ''">
				,author_name
			</if>
			,create_time
			,update_time
			,content
			,author_type
			,state
			<if test="summary != null and summary != ''">
				,summary
			</if>
		)
		VALUES
			(
				#{title}
				,#{author_id}
				<if test="author_name != null and author_name != ''">
					,#{author_name}
				</if>
				,#{create_time}
				,#{create_time}
				,#{content}
				,2
				,#{state}
				<if test="summary != null and summary != ''">
					,#{summary}
				</if>
			)
	</insert>
	<!-- 删除话题相关 -->
	<update id="deleteTopicRelated" parameterType="java.util.HashMap">
		DELETE
		FROM
			yj_topic_related
		WHERE
			topic_id = #{id}
	</update>
	<!-- 新增话题相关 -->
	<insert id="insertTopicRelated" parameterType="java.util.HashMap">
		INSERT INTO yj_topic_related (
			topic_id
			,create_time
			,type
			<if test="obj_id != null and obj_id != ''">
				,obj_id
			</if>
			<if test="article_title != null and article_title != ''">
				,article_title
			</if>
			<if test="obj_type != null and obj_type != ''">
				,obj_type
			</if>
			<if test="show_title != null and show_title != ''">
				,show_title
			</if>
			<if test="display_order != null and display_order != ''">
				,display_order
			</if>
			<if test="url != null and url != ''">
				,url
			</if>
		)
		VALUES
			(
				#{topic_id}
				,#{create_time}
				,#{type}
				<if test="obj_id != null and obj_id != ''">
					,#{obj_id}
				</if>
				<if test="article_title != null and article_title != ''">
					,#{article_title}
				</if>
				<if test="obj_type != null and obj_type != ''">
					,#{obj_type}
				</if>
				<if test="show_title != null and show_title != ''">
					,#{show_title}
				</if>
				<if test="display_order != null and display_order != ''">
					,#{display_order}
				</if>
			<if test="url != null and url != ''">
				,#{url}
			</if>
			)
	</insert>
	<!-- 修改话题相关 -->
	<update id="updateTopicRelated" parameterType="java.util.HashMap">
		UPDATE yj_topic_related
		SET update_time = #{update_time}
		 <if test="article_id != null and article_id != ''">
		 	,article_id = #{article_id}
		 </if>
		 <if test="article_title != null and article_title != ''">
		 	,article_title = #{article_title}
		 </if>
		 <if test="article_type != null and article_type != ''">
		 	,article_type = #{article_type}
		 </if>
		 <if test="type != null and type != ''">
		 	,type = #{type}
		 </if>
		 <if test="url != null and url != ''">
		 	,url = #{url}
		 </if>
		 <if test="status != null and status != ''">
		 	,`status` = #{status}
		 </if>
		 <if test="state != null and state != ''">
		 	,state = #{state}
		 </if>
		 <if test="display_order != null and display_order != ''">
		 	,display_order = #{display_order}
		 </if>
		 <if test="show_title != null and show_title != ''">
		 	,show_title = #{show_title}
		 </if>
		WHERE
			id = #{id}
	</update>
	<!-- 新增话题分享嘉宾 -->
	<insert id="insertTopicGuest" parameterType="java.util.HashMap">
		INSERT INTO yj_topic_guest (
			topic_id
			,user_id
			<if test="user_avatar != null and user_avatar != ''">
				,user_avatar
			</if>
			,user_type
			<if test="user_name != null and user_name != ''">
				,user_name
			</if>
			<if test="user_identity != null and user_identity != ''">
				,user_identity
			</if>
			<if test="user_v != null and user_v != ''">
				,user_v
			</if>
			<if test="is_send != null and is_send != '' ">
				,is_send
			</if>
			,display_order
		)
		VALUES
			(
				#{topic_id}
				,#{user_id}
				<if test="user_avatar != null and user_avatar != ''">
					,#{user_avatar}
				</if>
				,#{user_type}
				<if test="user_name != null and user_name != ''">
					,#{user_name}
				</if>
				<if test="user_identity != null and user_identity != ''">
					,#{user_identity}
				</if>
				<if test="user_v != null and user_v != ''">
					,#{user_v}
				</if>
				<if test="is_send != null and is_send != '' ">
					,#{is_send}
				</if>
				,#{display_order}
			)
	</insert>
	<!-- 删除话题分享嘉宾  -->
	<update id="deleteTopicGuest" parameterType="java.util.HashMap">
		DELETE
		FROM
			yj_topic_guest
		WHERE
			topic_id = #{id}
	</update>
	<!-- 删除话题其他分享嘉宾  -->
	<update id="deleteTopicGuestByOldids" parameterType="java.util.HashMap">
		DELETE
		FROM
			yj_topic_guest
		WHERE
			topic_id = #{id}
	     and id not in (${oldids})
	</update>
	<!-- 修改话题分享嘉宾 -->
	<update id="updateTopicGuest" parameterType="java.util.HashMap">
		UPDATE yj_topic_guest
		SET update_time = #{update_time}
		 <if test="user_id != null and user_id != ''">
		 	,user_id = #{user_id}
		 </if>
		 <if test="user_avatar != null and user_avatar != ''">
		 	,user_avatar = #{user_avatar}
		 </if>
		 <if test="user_type != null and user_type != ''">
		 	,user_type = #{user_type}
		 </if>
		 <if test="user_name != null and user_name != ''">
		 	,user_name = #{user_name}
		 </if>
		 <if test="user_identity != null and user_identity != ''">
		 	,user_identity = #{user_identity}
		 </if>
		 <if test="user_v != null and user_v != ''">
		 	,user_v = #{user_v}
		 </if>
		 <if test="display_order != null and display_order != ''">
		 	,display_order = #{display_order}
		 </if>
		 <if test="status != null and status != ''">
		 	,`status` = #{status}
		 </if>
		WHERE
			id = #{id}
	</update>
	<!-- 修改话题 -->
	<update id="updateTopic" parameterType="java.util.HashMap">
		UPDATE yj_topic
		SET update_time = #{update_time}
		 <if test="state != null and state != ''">
		 	,state = #{state}
		 </if>
		 <if test="status != null and status != ''">
		 	,status = #{status}
		 </if>
		 ,update_id = #{update_id}
		 <if test="update_name != null and update_name != ''">
		 	,update_name = #{update_name}
		 </if>
		 ,update_type = 2
		 <if test="title != null and title != ''">
		 	,title = #{title}
		 </if>
		 <if test="content != null and content != ''">
		 	,content = #{content}
		 </if>
		 <if test="summary != null and summary != ''">
		 	,summary = #{summary}
		 </if>
		WHERE
			id = #{id}
	</update>
	<!-- 查询话题大咖观点总条数 -->
	<select id="findTopicGuestOpinionCount" parameterType="java.util.HashMap" resultType="Integer">
		SELECT
			COUNT(*)
		FROM
			yj_topic_guest_opinion o,
			yj_topic_guest g,
			yj_topic t
		WHERE
			g.`status` = 1
		AND o.`status` = #{status}
		AND g.topic_id = #{topic_id}
		AND o.guest_id = g.id
		AND t.id = #{topic_id}
		AND t.id = g.topic_id
		<if test="start_time != null and start_time != ''">
			AND o.create_time >= #{start_time}
		</if>
		<if test="end_time != null and end_time != ''">
			<![CDATA[AND o.create_time <= #{end_time}]]>
		</if>
		<if test="content != null and content != ''">
			AND (o.content LIKE '%${content}%' or t.title LIKE '%${content}%')
		</if>
	</select>
	<!-- 查询话题大咖观点列表 -->
	<select id="findTopicGuestOpinion" parameterType="java.util.HashMap" resultType="java.util.HashMap">
		SELECT
			o.id,
			o.guest_id,
			g.user_id,
			g.user_name,
			o.content,
			o.is_voice,
			o.voice,
			o.editor,
			o.create_time,
			o.agent,
			o.voice_size,
			t.title,
			(
				SELECT
					u.realname
				FROM
					yj_yy_user u
				WHERE
					u.id = o.agent
			) agent_name
		FROM
			yj_topic_guest_opinion o,
			yj_topic_guest g,
			yj_topic t
		WHERE
			g.`status` = 1
		AND o.`status` = #{status}
		AND g.topic_id = #{topic_id}
		AND o.guest_id = g.id
		AND t.id = #{topic_id}
		AND t.id = g.topic_id
		<if test="start_time != null and start_time != ''">
			AND o.create_time >= #{start_time}
		</if>
		<if test="end_time != null and end_time != ''">
			<![CDATA[AND o.create_time <= #{end_time}]]>
		</if>
		<if test="content != null and content != ''">
			AND (o.content LIKE '%${content}%' or t.title LIKE '%${content}%')
		</if>
		<if test="y != null and y != ''">
			LIMIT ${x},${y}
		</if>
	</select>
	<!-- 修改话题大咖观点 -->
	<update id="updateTopicGuestOpinion" parameterType="java.util.HashMap">
		UPDATE yj_topic_guest_opinion
		SET id = #{id}
		<if test="status != null and status != ''">
		 	,`status` = #{status}
		</if>
		<if test="content != null and content != ''">
		 	,content = #{content}
		</if>
		<if test="editor != null and editor != ''">
		 	,editor = #{editor}
		</if>
		WHERE
			id = #{id}
	</update>
	<!-- 删除大咖观点语言翻译内容 -->
	<update id="deleteTopicGuestOpinion" parameterType="java.util.HashMap">
		UPDATE yj_topic_guest_opinion
		SET content = null
		<if test="editor != null and editor != ''">
		 	,editor = #{editor}
		</if>
		WHERE
			id = #{id}
	</update>
	<!-- 代发话题大咖观点 -->
	<insert id="insertTopicGuestOpinion" parameterType="java.util.HashMap" useGeneratedKeys="true" keyProperty="id">
		INSERT INTO yj_topic_guest_opinion (
			guest_id
			<if test="content != null and content != ''">
				,content
			</if>
			<if test="is_voice != null and is_voice != ''">
				,is_voice
			</if>
			<if test="voice != null and voice != ''">
				,voice
			</if>
			<if test="editor != null and editor != ''">
				,editor
			</if>
			,create_time
			<if test="agent != null and agent != ''">
				,agent
			</if>
			<if test="voice_size != null and voice_size != ''">
				,voice_size
			</if>
		)
		VALUES
			(
				#{guest_id}
				<if test="content != null and content != ''">
					,#{content}
				</if>
				<if test="is_voice != null and is_voice != ''">
					,#{is_voice}
				</if>
				<if test="voice != null and voice != ''">
					,#{voice}
				</if>
				<if test="editor != null and editor != ''">
					,#{editor}
				</if>
				,#{create_time}
				<if test="agent != null and agent != ''">
					,#{agent}
				</if>
				<if test="voice_size != null and voice_size != ''">
					,#{voice_size}
				</if>
			)
	</insert>
	
	<!-- 批量更新已推送过的受邀人的状态 -->
	<update id="updateGuestSendInfo" parameterType="java.util.List">
			update yj_topic_guest set is_send = 1 where id in (
				<foreach collection="list" item="item" index="index" separator="," >
					#{item.id}
				</foreach>
			)
	
	</update>
	
	<select id="findTopicGuestById" parameterType="java.util.HashMap" resultType="java.util.HashMap">
		SELECT
			*, (
				SELECT
					title
				FROM
					yj_topic
				WHERE
					id = topic_id
			) title
		FROM
			yj_topic_guest
		WHERE
			id = #{guest_id}
	</select>
</mapper>